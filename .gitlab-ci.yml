# GitLab CI/CD Configuration
stages:
  - lint
  - black
  - test
  - security
  - docs
  - deploy

# Cache node_modules for faster builds
cache:
  paths:
    - node_modules/
    - website/node_modules/

# Code style check job
lint:
  stage: lint
  image: node:latest
  script:
    - npm install
    - cd src/website && npm install --legacy-peer-deps && cd ../..
    - npx prettier --check "**/*.{js,jsx,ts,tsx,json,css,html,yaml,markdown,scss}"
  artifacts:
    paths:
      - prettier-report.json
    when: always

build-openapi-docs:
  stage: docs # or create a new stage like "docs"
  image: node:latest
  script:
    - npm install -g @redocly/cli
    - npx @redocly/cli build-docs openapi.json -o src/backend/resources/documentation/fastapi-doc.html
  artifacts:
    paths:
      - fastapi-doc.html
    when: always
    expire_in: 1 week

#pages:
#  stage: deploy
#  script:
#    - mkdir .public
#    - cp -r src/backend/resources/documentation/fastapi-doc.html .public/ # Replace 'docs/' with your folder containing the HTML/PDF
#    - mv .public public
#  artifacts:
#    paths:
#      - public

# Python code style check job
black:
  stage: black
  image: python:3.11-slim
  script:
    - pip install black>=23.9.1
    - black --check src/ tests/
  artifacts:
    paths:
      - black-report.json
    when: always

# Ruff job
ruff:
  stage: lint
  image: python:3.11-slim
  script:
    - pip install ruff # Install Ruff for linting and type checking
    - ruff check # Run Ruff for linting and type checking
  artifacts:
    paths:
      - ruff-report.json # Save Ruff's report for artifacts
    when: always

## Test coverage checks for python files
coverage:
  stage: test
  image: python:3.11-slim
  script:
    - pip install -r requirements.txt
    - pytest tests/backend_tests --cov=./src/backend --cov-report=xml --junitxml=test-report.xml
  artifacts:
    reports:
      junit: test-report.xml
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    paths:
      - test-report.xml
      - coverage.xml
    when: always
  allow_failure: true
# Dependency security check
dependency-scan:
  stage: security
  image: node:latest
  script:
    - npm install -g npm-audit-resolver
    - npm install
    - cd src/website && npm install --legacy-peer-deps && cd ../..
    - npm audit --production || true
    - cd src/website && npm audit --production || true
  allow_failure: true
  artifacts:
    paths:
      - security-report.txt
      - website-security-report.txt
    when: always
